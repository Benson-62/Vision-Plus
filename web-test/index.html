<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Attendance - Liveness Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    video, canvas {
      border: 2px solid #444;
      border-radius: 8px;
      max-width: 100%;
    }
    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input, button {
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      outline: none;
    }
    button {
      background: #0a84ff;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
    #result {
      margin-top: 15px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Smart Attendance - Liveness Check</h1>

  <!-- Email input -->
  <div id="controls">
    <input type="email" id="email" placeholder="Enter your registered email" />
    <button id="startCamera">Start Camera</button>
    <button id="checkinBtn" disabled>Start Liveness Check</button>
  </div>

  <!-- Live video -->
  <video id="video" width="400" height="300" autoplay playsinline></video>

  <!-- Hidden canvases to capture frames -->
  <canvas id="canvas1" width="400" height="300" style="display:none;"></canvas>
  <canvas id="canvas2" width="400" height="300" style="display:none;"></canvas>

  <div id="result"></div>

  <script>
    const video = document.getElementById("video");
    const canvas1 = document.getElementById("canvas1");
    const canvas2 = document.getElementById("canvas2");
    const startCameraBtn = document.getElementById("startCamera");
    const checkinBtn = document.getElementById("checkinBtn");
    const emailInput = document.getElementById("email");
    const resultDiv = document.getElementById("result");

    let stream = null;

    // 1) Start camera
    startCameraBtn.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        checkinBtn.disabled = false;
        resultDiv.textContent = "Camera started. Click 'Start Liveness Check' when ready.";
      } catch (err) {
        console.error(err);
        resultDiv.textContent = "Could not access camera: " + err.message;
      }
    };

    // Helper: capture current frame from video into a canvas and return a Blob
    function captureFrameToBlob(canvas) {
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return new Promise((resolve) => {
        canvas.toBlob((blob) => {
          resolve(blob);
        }, "image/jpeg", 0.9);
      });
    }

    // 2) Liveness check: capture two frames and send to backend
    checkinBtn.onclick = async () => {
      const email = emailInput.value.trim();
      if (!email) {
        resultDiv.textContent = "Please enter your registered email.";
        return;
      }
      if (!stream) {
        resultDiv.textContent = "Camera is not started.";
        return;
      }

      resultDiv.textContent = "Capturing frames... Please move your head or blink.";
      checkinBtn.disabled = true;

      try {
        // Capture first frame
        const blob1 = await captureFrameToBlob(canvas1);

        // Wait 1 second, let user move a bit
        await new Promise((res) => setTimeout(res, 1000));

        // Capture second frame
        const blob2 = await captureFrameToBlob(canvas2);

        // Build form-data
        const formData = new FormData();
        formData.append("email", email);
        formData.append("image1", blob1, "frame1.jpg");
        formData.append("image2", blob2, "frame2.jpg");

        //  Backend URL (FastAPI)
        const apiUrl = "http://127.0.0.1:8000/checkin_live";

        resultDiv.textContent = "Sending to server...";

        const response = await fetch(apiUrl, {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        resultDiv.textContent = "Server response:\n" + JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        resultDiv.textContent = "Error: " + err.message;
      } finally {
        checkinBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
